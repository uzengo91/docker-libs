name: Docker

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'build.yaml'

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
  ALIYUN_REGISTRY_BASE_PATH: "${{ secrets.ALIYUN_REGISTRY_BASE_PATH }}"
  OSS_HOST: "${{ secrets.ALIYUN_OSS_HOST }}"

jobs:

  build:
    name: Pull
    runs-on: ubuntu-22.04
    steps:
    - name: Before freeing up disk space
      run: |
        echo "Before freeing up disk space"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    # 增加可用磁盘空间
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:

        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        # 如果空间还是不够用，可以把以下开启，清理出更多空间
        # remove-android: 'true'
        # remove-codeql: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: Restart docker
      run: sudo service docker restart

    - name: Free up disk space complete
      run: |
        echo "Free up disk space complete"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    - name: Multi YAML Read
      uses: actions-tools/yaml-outputs@v2
      id: yaml
      with:
        file-path: ${{ github.workspace }}/build.yaml
        export-env-variables: 'true'

    - name: Runtime Base Dockerfile Libs
      id: runtime-base-dockerfile-libs
      run: |
        echo "runtime-base-dockerfile-libs start"
        echo "==================================================="
        LENGTH=0
        while true
        do
          path="runtimes__${LENGTH}__folderPath"
          if [ -z "$(eval "echo \${$path}")" ]; then
            break
          fi
          filePath=$(eval "echo \${$path}")
          imageName="runtimes__${LENGTH}__imageName"
          if [ -z "$(eval "echo \${$imageName}")" ]; then
            break
          fi
          image=$(eval "echo \${$imageName}")
          enable="runtimes__${LENGTH}__enabled"
          if [ "$(eval "echo \${$enable}")" == "false" ]; then
            echo "folderPath $filePath, image $image dockerfile is disabled"
            LENGTH=$((LENGTH+1))
            continue
          fi

          platformName="runtimes__${LENGTH}__platform"
          platform=$(eval "echo \${$platformName}")
          echo "platform: $platform"

          echo "folderPath: $filePath, imageName: $image"

          docker buildx build --platform $platform --build-arg OSS_HOST -t $image --load $filePath
          LENGTH=$((LENGTH+1))
        done

        echo "runtime-base-dockerfile-libs end"
        echo "==================================================="

    - name: Dockerfile Build And Push
      id: dockerfile-build-push
      run: |
        echo "dockerfile-build-push start"
        echo "==================================================="
        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY
        LENGTH=0
        while true
        do
          path="dockerFiles__${LENGTH}__folderPath"
          if [ -z "$(eval "echo \${$path}")" ]; then
            break
          fi
          filePath=$(eval "echo \${$path}")
          imageName="dockerFiles__${LENGTH}__imageName"
          if [ -z "$(eval "echo \${$imageName}")" ]; then
            break
          fi
          image=$(eval "echo \${$imageName}")
          enable="dockerFiles__${LENGTH}__enabled"
          if [ "$(eval "echo \${$enable}")" == "false" ]; then
            echo "folderPath $image dockerfile is disabled"
            LENGTH=$((LENGTH+1))
            continue
          fi
          echo "folderPath: $filePath, imageName: $image"
          tagName="dockerFiles__${LENGTH}__pushTag"
          tag=$(eval "echo \${$tagName}")
          pushTag=""

          # 不存在tag 或者tag为空
          if [ -z "$tag" ]; then
            pushTag=$(date "+%Y%m%d%H%M%S")
            #4位随机数
            rand=$(cat /proc/sys/kernel/random/uuid | cut -b 1-4)
            pushTag=$image:$pushTag-$rand
          else
            pushTag=$image:$tag
          fi
          echo "pushName: $pushTag"

          platformName="dockerFiles__${LENGTH}__platform"
          platform=$(eval "echo \${$platformName}")
          echo "platform: $platform"

          new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$ALIYUN_REGISTRY_BASE_PATH/$pushTag"

          docker buildx build --platform $platform -t $new_image --push $filePath

          LENGTH=$((LENGTH+1))
        done

        echo "image-build-push end"
        echo "==================================================="

    - name: Image Build And Push
      id: image-build-push
      run: |
        echo "image-build-push start"
        echo "==================================================="
        docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY
        LENGTH=0
        while true
        do
          name="images__${LENGTH}__image"
          if [ -z "$(eval "echo \${$name}")" ]; then
              break
          fi
          image=$(eval "echo \${$name}")
          enable="images__${LENGTH}__enabled"
          if [ "$(eval "echo \${$enable}")" == "false" ]; then
              echo "image $image is disabled"
              LENGTH=$((LENGTH+1))
              continue
          fi
          echo "image: $image"
          platformName="images__${LENGTH}__platform"
          platform=$(eval "echo \${$platformName}")
          echo "platform: $platform"
          pushName="images__${LENGTH}__pushName"
          pushTag=$(eval "echo \${$pushName}")
          echo "pushName: $pushTag"

          new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$ALIYUN_REGISTRY_BASE_PATH/$pushTag"

          # If platform contains a comma, it's multi-platform
          if [[ $platform == *,* ]]; then
            echo "Multi-platform image, will use manifest to combine"
            # Split platform string
            IFS=',' read -ra platforms <<< "$platform"
            images_to_push_for_manifest=""
            for p in "${platforms[@]}"; do
              arch_tag_suffix=""
              if [[ $p == "linux/amd64" ]]; then
                arch_tag_suffix="amd64"
              elif [[ $p == "linux/arm64" ]]; then
                arch_tag_suffix="arm64"
              else
                # Create a simple suffix from platform string
                arch_tag_suffix=$(echo "$p" | sed 's|/|-|g')
              fi

              echo "Pulling image $image for platform $p"
              docker pull --platform $p $image

              arch_tagged_image="$new_image-$arch_tag_suffix"

              echo "Tagging $image as $arch_tagged_image"
              docker tag $image $arch_tagged_image

              echo "Pushing platform-specific image: $arch_tagged_image"
              docker push $arch_tagged_image

              images_to_push_for_manifest="$images_to_push_for_manifest $arch_tagged_image"

              # Clean up local images to save space
              docker rmi $image
              docker rmi $arch_tagged_image
            done

            echo "Creating manifest $new_image with images: $images_to_push_for_manifest"
            docker manifest create $new_image $images_to_push_for_manifest
            echo "Pushing manifest $new_image"
            docker manifest push $new_image

          else
            # Single platform logic
            echo "Pulling single-platform image $image for platform $platform"
            docker pull --platform $platform $image
            echo "Tagging $image as $new_image"
            docker tag $image $new_image
            echo "Pushing $new_image"
            docker push $new_image

            # Clean up local images
            docker rmi $image
            docker rmi $new_image
          fi

          echo "Disk space status"
          echo "=============================================================================="
          df -hT
          echo "=============================================================================="

          LENGTH=$((LENGTH+1))
        done

        echo "image-build-push end"
        echo "==================================================="